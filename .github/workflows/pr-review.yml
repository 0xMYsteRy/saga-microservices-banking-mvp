name: PR Review Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  bot-review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"

      - name: Run targeted Maven tests
        id: maven
        continue-on-error: true
        run: |
          set -o pipefail
          mvn -pl common-lib clean test | tee maven.log

      - name: Create PR review comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outcome = '${{ steps.maven.outcome }}';
            let body = '';

            if (outcome === 'success') {
              body = [
                '✅ **Automated Maven check succeeded**',
                '',
                '- Command: `mvn -pl common-lib clean test`',
                '- Result: All tests passed.'
              ].join('\n');
            } else {
              let tail = '';
              try {
                const log = fs.readFileSync('maven.log', 'utf8');
                tail = log.split('\n').slice(-60).join('\n');
              } catch (err) {
                tail = 'Unable to read maven.log';
              }

              body = [
                '❌ **Automated Maven check failed**',
                '',
                '- Command: `mvn -pl common-lib clean test`',
                '- Result: Please review the tail of the Maven log below:',
                '',
                '```',
                tail,
                '```'
              ].join('\n');
            }

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body,
              event: 'COMMENT'
            });

      - name: Fail workflow on test failure
        if: steps.maven.outcome != 'success'
        run: exit 1
